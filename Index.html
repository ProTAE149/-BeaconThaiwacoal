function onFormSubmit(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  var data = sheet.getDataRange().getValues();
  
  // 1. ดึงค่าจาก Event Object (e.namedValues จะแม่นยำกว่า e.values เพราะอิงตามหัวข้อคอลัมน์)
  var responses = e.namedValues;
  var timestamp = responses['Timestamp'] ? responses['Timestamp'][0] : "";
  var userId    = responses['Line User ID'] ? responses['Line User ID'][0] : ""; // แก้ชื่อให้ตรงกับหัวคอลัมน์ใน Form
  var name      = responses['ชื่อ-นามสกุล'] ? responses['ชื่อ-นามสกุล'][0] : "";
  var email     = responses['อีเมล'] ? responses['อีเมล'][0] : "";

  var isDuplicate = false;
  var reason = "";
  var lastRow = sheet.getLastRow();

  // 2. ตรวจสอบข้อมูลซ้ำ (วนลูปเช็คจากแถวที่ 2 จนถึงแถวก่อนหน้าแถวล่าสุด)
  // เริ่มที่ i = 1 (แถวที่ 2) และจบที่ i < data.length - 1 (ไม่เช็คแถวตัวเอง)
  for (var i = 1; i < data.length - 1; i++) {
    if (userId && data[i][1] == userId) { isDuplicate = true; reason = "Line User ID นี้เคยลงทะเบียนแล้ว"; break; }
    if (name && data[i][2] == name)     { isDuplicate = true; reason = "ชื่อ-นามสกุลนี้มีอยู่ในระบบแล้ว"; break; }
    if (email && data[i][4] == email)   { isDuplicate = true; reason = "อีเมลนี้เคยใช้งานแล้ว"; break; }
  }

  // 3. จัดการผลลัพธ์
  if (!isDuplicate) {
    // --- กรณีข้อมูลใหม่: ส่งอีเมลยืนยัน ---
    MailApp.sendEmail({
      to: email,
      subject: "ยืนยันการสมัครสมาชิกสำเร็จ",
      body: "สวัสดีคุณ " + name + "\nระบบได้รับข้อมูลการสมัครของท่านเรียบร้อยแล้วเมื่อ " + timestamp
    });
    
    // (Optional) ส่ง LINE Notify ตรงนี้ได้เลย
  } else {
    // --- กรณีข้อมูลซ้ำ: ส่งแจ้งเตือนและลบแถวที่ซ้ำออก ---
    MailApp.sendEmail({
      to: email,
      subject: "แจ้งเตือนการสมัครซ้ำ",
      body: "ขออภัย คุณ " + name + "\nไม่สามารถสมัครได้เนื่องจาก: " + reason
    });

    // ลบแถวล่าสุดที่เพิ่งเพิ่มเข้ามา เพราะเป็นข้อมูลซ้ำ
    sheet.deleteRow(lastRow);
    
    // บันทึก Log ไว้ดู (สร้าง Sheet ชื่อ 'Logs' เพิ่มถ้าต้องการ)
    console.warn("พบข้อมูลซ้ำ: " + reason + " จาก " + email);
  }
}